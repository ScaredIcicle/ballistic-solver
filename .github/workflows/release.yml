name: Native Release Assets

on:
  workflow_run:
    workflows: ["Wheels"]
    types: [completed]

permissions:
  contents: write

jobs:
  native:
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      startsWith(github.event.workflow_run.ref, 'refs/tags/v')
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Configure (CMake Release)
        run: cmake -S . -B build -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build --config Release -j

      - name: Test
        run: ctest --test-dir build -C Release --output-on-failure

      - name: Package native (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist
          cp -f include/ballistic_solver_c_api.h dist/

          if [[ "${RUNNER_OS}" == "Linux" ]]; then
            libpath="$(find build -maxdepth 6 -type f -name "libballistic_solver.so" -print -quit)"
          else
            libpath="$(find build -maxdepth 6 -type f -name "libballistic_solver.dylib" -print -quit)"
          fi

          if [[ -z "${libpath:-}" ]]; then
            echo "ERROR: shared library not found under build/"
            exit 1
          fi

          cp -f "$libpath" dist/

          ref="${{ github.event.workflow_run.ref }}"
          tag="${ref#refs/tags/}"
          os="$(echo "${RUNNER_OS}" | tr '[:upper:]' '[:lower:]')"
          (cd dist && zip -r "../ballistic_${tag}_${os}.zip" .)

      - name: Package native (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force dist | Out-Null
          Copy-Item -Force include\ballistic_solver_c_api.h dist\

          $dll = Get-ChildItem -Path build -Recurse -Filter ballistic_solver.dll -ErrorAction SilentlyContinue | Select-Object -First 1
          if (-not $dll)
          {
            Write-Error "ERROR: ballistic_solver.dll not found under build/"
            exit 1
          }
          Copy-Item -Force $dll.FullName dist\

          $ref = "${{ github.event.workflow_run.ref }}"
          $tag = $ref -replace '^refs/tags/', ''
          Compress-Archive -Path dist\* -DestinationPath "ballistic_${tag}_windows.zip" -Force

      - uses: actions/upload-artifact@v4
        with:
          name: native-${{ runner.os }}
          path: ballistic_*.zip

  upload:
    needs: [native]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Upload zips to existing Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ref="${{ github.event.workflow_run.ref }}"
          tag="${ref#refs/tags/}"
          gh release upload "$tag" dist/*.zip --clobber
